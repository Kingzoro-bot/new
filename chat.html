<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat Platform</title>
    <style>
        /* Your existing styles */
    </style>
</head>
<body>
    <div id="chat-container">
        <h1 id="chat-header">Chat Room</h1>
        <div id="messages"></div>
        <div id="input-area">
            <input id="message-input" type="text" placeholder="Type your message..." />
            <button id="send-button">Send</button>
            <button id="upload-button">üìÅ</button>
            <input id="file-input" type="file" />
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const nickname = localStorage.getItem('nickname');
        const messagesDiv = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const uploadButton = document.getElementById('upload-button');
        const fileInput = document.getElementById('file-input');
        const STORAGE_KEY = "chatMessages";

        if (!nickname) {
            window.location.href = '/';
        }

        // Load and display messages from local storage
        loadMessagesFromLocalStorage();

        // Send text message
        sendButton.addEventListener('click', () => {
            const message = messageInput.value.trim();
            if (message) {
                const timestamp = Date.now();
                const messageData = { user: nickname, message, timestamp };

                addMessageToLocalStorage(messageData);
                displayMessage(messageData, true);

                socket.emit('chatMessage', message);
                messageInput.value = '';
            }
        });

        // Trigger file input dialog
        uploadButton.addEventListener('click', () => {
            fileInput.click();
        });

        // Handle file upload
        fileInput.addEventListener('change', () => {
            const file = fileInput.files[0];
            if (file) {
                const formData = new FormData();
                formData.append('file', file);

                fetch('/upload', {
                    method: 'POST',
                    body: formData,
                })
                    .then((response) => response.json())
                    .then((data) => {
                        if (data.success) {
                            const messageData = {
                                user: nickname,
                                fileUrl: data.fileUrl,
                                fileType: file.type,
                                timestamp: Date.now()
                            };

                            addMessageToLocalStorage(messageData);
                            displayFileMessage(messageData, true);

                            socket.emit('fileMessage', messageData);
                        } else {
                            alert('File upload failed!');
                        }
                    });

                fileInput.value = ''; // Reset the file input
            }
        });

        // Display text messages received from the server
        socket.on('chatMessage', (data) => {
            addMessageToLocalStorage(data);
            displayMessage(data, false);
        });

        // Display file messages received from the server
        socket.on('fileMessage', (data) => {
            addMessageToLocalStorage(data);
            displayFileMessage(data, false);
        });

        // Add message to local storage
        function addMessageToLocalStorage(messageData) {
            const storedMessages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            storedMessages.push(messageData);

            // Keep only messages from the last 24 hours
            const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;
            const recentMessages = storedMessages.filter(msg => msg.timestamp >= oneDayAgo);

            localStorage.setItem(STORAGE_KEY, JSON.stringify(recentMessages));
        }

        // Load messages from local storage and display them
        function loadMessagesFromLocalStorage() {
            const storedMessages = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
            const oneDayAgo = Date.now() - 24 * 60 * 60 * 1000;

            const recentMessages = storedMessages.filter(msg => msg.timestamp >= oneDayAgo);
            recentMessages.forEach(msg => {
                if (msg.fileUrl) {
                    displayFileMessage(msg, msg.user === nickname);
                } else {
                    displayMessage(msg, msg.user === nickname);
                }
            });

            // Update local storage to remove old messages
            localStorage.setItem(STORAGE_KEY, JSON.stringify(recentMessages));
        }

        // Display a text message
        function displayMessage(data, isSent) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', isSent ? 'sent' : 'received');
            messageElement.textContent = `${data.user}: ${data.message}`;

            const timestampElement = document.createElement('span');
            timestampElement.classList.add('timestamp');
            timestampElement.textContent = formatTimestamp(data.timestamp);
            messageElement.appendChild(timestampElement);

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Display a file message
        function displayFileMessage(data, isSent) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', isSent ? 'sent' : 'received');

            const userText = document.createElement('div');
            userText.textContent = `${data.user}:`;
            messageElement.appendChild(userText);

            let mediaElement;
            if (data.fileType.startsWith('image/')) {
                mediaElement = document.createElement('img');
                mediaElement.src = data.fileUrl;
                mediaElement.alt = 'Uploaded Image';
                mediaElement.style.maxWidth = '100%';
                mediaElement.style.maxHeight = '200px';
            } else if (data.fileType.startsWith('audio/')) {
                mediaElement = document.createElement('audio');
                mediaElement.controls = true;
                mediaElement.src = data.fileUrl;
            } else if (data.fileType.startsWith('video/')) {
                mediaElement = document.createElement('video');
                mediaElement.controls = true;
                mediaElement.style.maxWidth = '100%';
                mediaElement.src = data.fileUrl;
            }

            if (mediaElement) {
                messageElement.appendChild(mediaElement);
            }

            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        // Format timestamps
        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            const seconds = date.getSeconds().toString().padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }
    </script>
</body>
</html>